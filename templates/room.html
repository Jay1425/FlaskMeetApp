<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call - Room {{ room_id }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: white;
            overflow: hidden;
        }

        .video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px;
        }

        .video-wrapper {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .video-wrapper.main-video {
            width: calc(100% - 220px);
            height: calc(100% - 20px);
        }

        .video-wrapper.small-video {
            width: 200px;
            height: 150px;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            border: 2px solid #667eea;
        }

        .video-wrapper.participant-video {
            width: calc(50% - 10px);
            height: calc(50% - 10px);
            min-width: 300px;
            min-height: 200px;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background: #333;
        }

        .video-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
            padding: 15px;
            color: white;
        }

        .username {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .status {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 100;
        }

        .control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .control-btn:hover {
            transform: scale(1.1);
        }

        .btn-video {
            background: #4CAF50;
            color: white;
        }

        .btn-video.off {
            background: #f44336;
        }

        .btn-audio {
            background: #2196F3;
            color: white;
        }

        .btn-audio.off {
            background: #f44336;
        }

        .btn-hangup {
            background: #f44336;
            color: white;
            width: 70px;
            height: 70px;
        }

        .btn-screen {
            background: #FF9800;
            color: white;
        }

        .room-info {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            z-index: 100;
        }

        .room-id {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .participant-count {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .waiting-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 50;
        }

        .waiting-message h2 {
            margin-bottom: 20px;
            font-size: 2em;
        }

        .waiting-message p {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .share-link {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            border: 1px dashed rgba(255, 255, 255, 0.3);
        }

        .share-link input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            text-align: center;
        }

        .copy-btn {
            margin-top: 10px;
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 200;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        @media (max-width: 768px) {
            .video-wrapper.main-video {
                width: 100%;
                height: calc(100% - 140px);
            }

            .video-wrapper.small-video {
                width: 120px;
                height: 90px;
                top: 10px;
                right: 10px;
            }

            .controls {
                bottom: 20px;
                gap: 10px;
            }

            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .btn-hangup {
                width: 60px;
                height: 60px;
            }
        }
    </style>
</head>
<body>
    <div class="room-info">
        <div class="room-id">Room: {{ room_id }}</div>
        <div class="participant-count">Participants: <span id="participantCount">1</span></div>
    </div>

    <div class="video-container" id="videoContainer">
        <div class="waiting-message" id="waitingMessage">
            <h2>üé• Waiting for others to join...</h2>
            <p>Share the room link with others to start the video call</p>
            <div class="share-link">
                <input type="text" id="roomLink" readonly>
                <button class="copy-btn" onclick="copyRoomLink()">Copy Link</button>
            </div>
        </div>
    </div>

    <div class="controls">
        <button class="control-btn btn-video" id="videoBtn" onclick="toggleVideo()" title="Toggle Video">
            üìπ
        </button>
        <button class="control-btn btn-audio" id="audioBtn" onclick="toggleAudio()" title="Toggle Audio">
            üé§
        </button>
        <button class="control-btn btn-screen" id="screenBtn" onclick="toggleScreen()" title="Share Screen">
            üñ•Ô∏è
        </button>
        <button class="control-btn btn-hangup" onclick="hangUp()" title="Leave Call">
            üìû
        </button>
    </div>

    <div class="notification" id="notification"></div>

    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    
    <script>
        const socket = io();
        const roomId = '{{ room_id }}';
        const username = localStorage.getItem('username') || 'Anonymous';
        
        let localStream = null;
        let peerConnections = {};
        let isVideoEnabled = true;
        let isAudioEnabled = true;
        let isScreenSharing = false;
        
        // ICE servers configuration
        const iceServers = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ],
            iceCandidatePoolSize: 10
        };

        // Initialize the app
        async function init() {
            try {
                // Set room link
                document.getElementById('roomLink').value = window.location.href;
                
                // Check if browser supports WebRTC
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('WebRTC is not supported by this browser');
                }
                
                console.log('Initializing video call app...');
                
                // Get user media first
                await getUserMedia();
                console.log('Media access successful');
                
                // Connect to socket
                if (!socket.connected) {
                    socket.connect();
                }
                
                // Wait for socket connection
                socket.on('connect', () => {
                    console.log('Socket connected, ID:', socket.id);
                    // Join the room after connection
                    socket.emit('join_room', {
                        room_id: roomId,
                        username: username
                    });
                    
                    // Signal that we're ready for WebRTC
                    setTimeout(() => {
                        socket.emit('ready', { room_id: roomId });
                    }, 1000);
                });
                
                if (socket.connected) {
                    console.log('Socket already connected, ID:', socket.id);
                    socket.emit('join_room', {
                        room_id: roomId,
                        username: username
                    });
                    
                    // Signal that we're ready for WebRTC
                    setTimeout(() => {
                        socket.emit('ready', { room_id: roomId });
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error initializing:', error);
                showNotification(`Initialization failed: ${error.message}`, 'error');
                
                // Show error message to user
                const waitingMessage = document.getElementById('waitingMessage');
                waitingMessage.innerHTML = `
                    <h2>‚ùå Error</h2>
                    <p>${error.message}</p>
                    <p>Please refresh the page and try again.</p>
                    <button onclick="location.reload()" class="copy-btn">Refresh Page</button>
                `;
            }
        }

        async function getUserMedia() {
            try {
                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                };
                
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Display local video
                displayLocalVideo();
                
                console.log('Camera and microphone access granted');
                
            } catch (error) {
                console.error('Error accessing media devices:', error);
                
                // Try with more basic constraints
                try {
                    localStream = await navigator.mediaDevices.getUserMedia({
                        video: true,
                        audio: true
                    });
                    displayLocalVideo();
                    console.log('Camera and microphone access granted with basic constraints');
                } catch (fallbackError) {
                    console.error('Fallback media access failed:', fallbackError);
                    showNotification('Camera/microphone access failed. Please check permissions.', 'error');
                    throw fallbackError;
                }
            }
        }

        function displayLocalVideo() {
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'video-wrapper main-video';
            videoWrapper.id = 'localVideo';
            
            const video = document.createElement('video');
            video.srcObject = localStream;
            video.autoplay = true;
            video.muted = true;
            video.playsInline = true;
            
            // Ensure video plays
            video.onloadedmetadata = () => {
                video.play().catch(e => console.log('Video play failed:', e));
            };
            
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            overlay.innerHTML = `
                <div class="username">${username} (You)</div>
                <div class="status">Local</div>
            `;
            
            videoWrapper.appendChild(video);
            videoWrapper.appendChild(overlay);
            
            // Clear any existing content and add video
            const container = document.getElementById('videoContainer');
            const existingLocal = document.getElementById('localVideo');
            if (existingLocal) {
                existingLocal.remove();
            }
            
            container.appendChild(videoWrapper);
            console.log('Local video displayed');
        }

        function createPeerConnection(userId) {
            console.log('Creating peer connection for:', userId);
            const pc = new RTCPeerConnection(iceServers);
            
            // Add local stream tracks if available
            if (localStream) {
                console.log('Adding local stream tracks to peer connection');
                localStream.getTracks().forEach((track, index) => {
                    console.log(`Adding track ${index}:`, track.kind, track.enabled);
                    pc.addTrack(track, localStream);
                });
            } else {
                console.warn('No local stream available when creating peer connection');
            }
            
            // Handle remote stream
            pc.ontrack = (event) => {
                console.log('Received remote track from:', userId, 'Track kind:', event.track.kind);
                console.log('Remote streams:', event.streams);
                
                if (event.streams && event.streams[0]) {
                    const remoteStream = event.streams[0];
                    console.log('Remote stream tracks:', remoteStream.getTracks().length);
                    
                    // Check if stream has video tracks
                    const videoTracks = remoteStream.getVideoTracks();
                    const audioTracks = remoteStream.getAudioTracks();
                    console.log('Video tracks:', videoTracks.length, 'Audio tracks:', audioTracks.length);
                    
                    if (videoTracks.length > 0) {
                        console.log('Video track enabled:', videoTracks[0].enabled);
                        console.log('Video track ready state:', videoTracks[0].readyState);
                    }
                    
                    displayRemoteVideo(userId, remoteStream);
                } else {
                    console.error('No remote stream in track event');
                }
            };
            
            // Handle ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('Sending ICE candidate to:', userId);
                    socket.emit('ice_candidate', {
                        target: userId,
                        candidate: event.candidate
                    });
                } else {
                    console.log('All ICE candidates sent for:', userId);
                }
            };
            
            // Handle connection state changes
            pc.onconnectionstatechange = () => {
                console.log(`Connection state with ${userId}:`, pc.connectionState);
                if (pc.connectionState === 'connected') {
                    console.log('Peer connection established with:', userId);
                } else if (pc.connectionState === 'failed') {
                    console.log('Connection failed, trying to restart ICE');
                    pc.restartIce();
                }
            };
            
            // Handle ICE connection state changes
            pc.oniceconnectionstatechange = () => {
                console.log(`ICE connection state with ${userId}:`, pc.iceConnectionState);
                if (pc.iceConnectionState === 'connected' || pc.iceConnectionState === 'completed') {
                    console.log('ICE connection established with:', userId);
                }
            };
            
            // Handle data channel if needed
            pc.ondatachannel = (event) => {
                console.log('Data channel received from:', userId);
            };
            
            peerConnections[userId] = pc;
            console.log('Peer connection created and stored for:', userId);
            return pc;
        }

        function displayRemoteVideo(userId, stream) {
            console.log('Displaying remote video for user:', userId);
            console.log('Stream details:', stream);
            console.log('Stream active:', stream.active);
            console.log('Stream tracks:', stream.getTracks().map(t => ({kind: t.kind, enabled: t.enabled, readyState: t.readyState})));
            
            // Remove waiting message
            const waitingMessage = document.getElementById('waitingMessage');
            if (waitingMessage) {
                waitingMessage.style.display = 'none';
            }
            
            // Adjust local video to small size
            const localVideo = document.getElementById('localVideo');
            if (localVideo) {
                localVideo.className = 'video-wrapper small-video';
            }
            
            // Remove existing remote video for this user
            const existingVideo = document.getElementById(`remoteVideo_${userId}`);
            if (existingVideo) {
                console.log('Removing existing video for:', userId);
                existingVideo.remove();
            }
            
            const videoWrapper = document.createElement('div');
            videoWrapper.className = 'video-wrapper main-video';
            videoWrapper.id = `remoteVideo_${userId}`;
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            video.controls = false;
            
            // Add event listeners for debugging
            video.onloadstart = () => console.log('Video load started for:', userId);
            video.onloadeddata = () => console.log('Video data loaded for:', userId);
            video.oncanplay = () => console.log('Video can play for:', userId);
            video.onplaying = () => console.log('Video playing for:', userId);
            video.onerror = (e) => console.error('Video error for:', userId, e);
            
            // Ensure video plays
            video.onloadedmetadata = () => {
                console.log('Video metadata loaded for:', userId);
                console.log('Video dimensions:', video.videoWidth, 'x', video.videoHeight);
                video.play().then(() => {
                    console.log('Video play successful for:', userId);
                }).catch(e => {
                    console.error('Video play failed for:', userId, e);
                });
            };
            
            // Force play after a short delay
            setTimeout(() => {
                if (video.paused) {
                    console.log('Forcing video play for:', userId);
                    video.play().catch(e => console.error('Force play failed:', e));
                }
            }, 1000);
            
            const overlay = document.createElement('div');
            overlay.className = 'video-overlay';
            overlay.innerHTML = `
                <div class="username">Remote Participant</div>
                <div class="status">Connected</div>
            `;
            
            videoWrapper.appendChild(video);
            videoWrapper.appendChild(overlay);
            document.getElementById('videoContainer').appendChild(videoWrapper);
            
            updateParticipantCount();
            showNotification('Participant video connected!');
            
            // Monitor stream status
            stream.getTracks().forEach(track => {
                track.onended = () => {
                    console.log(`Track ${track.kind} ended for user:`, userId);
                };
                track.onmute = () => {
                    console.log(`Track ${track.kind} muted for user:`, userId);
                };
                track.onunmute = () => {
                    console.log(`Track ${track.kind} unmuted for user:`, userId);
                };
            });
        }

        function removeRemoteVideo(userId) {
            const videoElement = document.getElementById(`remoteVideo_${userId}`);
            if (videoElement) {
                videoElement.remove();
            }
            
            // If no remote videos, show waiting message
            const remoteVideos = document.querySelectorAll('[id^="remoteVideo_"]');
            if (remoteVideos.length === 0) {
                const waitingMessage = document.getElementById('waitingMessage');
                if (waitingMessage) {
                    waitingMessage.style.display = 'block';
                }
                
                // Make local video main if no remote participants
                const localVideo = document.getElementById('localVideo');
                if (localVideo) {
                    localVideo.className = 'video-wrapper main-video';
                }
            }
            
            updateParticipantCount();
        }

        function updateParticipantCount() {
            const remoteVideos = document.querySelectorAll('[id^="remoteVideo_"]');
            const count = remoteVideos.length + 1; // +1 for local user
            document.getElementById('participantCount').textContent = count;
        }

        // Add ready signal handler
        socket.on('ready', (data) => {
            console.log('Received ready signal from:', data.user_id);
            // This user is ready to start WebRTC connection
        });

        // Socket event handlers
        socket.on('user_joined', async (data) => {
            console.log('User joined:', data);
            showNotification(`${data.username} joined the call`);
            
            // Only create offer if this is not the current user
            if (data.user_id !== socket.id) {
                console.log('Creating peer connection for:', data.user_id);
                
                // Wait a moment for the other user to be ready
                setTimeout(async () => {
                    try {
                        const pc = createPeerConnection(data.user_id);
                        
                        // Create offer
                        console.log('Creating offer for:', data.user_id);
                        const offer = await pc.createOffer({
                            offerToReceiveAudio: true,
                            offerToReceiveVideo: true
                        });
                        
                        await pc.setLocalDescription(offer);
                        console.log('Sending offer to:', data.user_id);
                        
                        socket.emit('offer', {
                            target: data.user_id,
                            offer: offer
                        });
                    } catch (error) {
                        console.error('Error creating offer:', error);
                    }
                }, 1500);
            }
        });

        socket.on('user_left', (data) => {
            showNotification('A participant left the call');
            removeRemoteVideo(data.user_id);
            
            if (peerConnections[data.user_id]) {
                peerConnections[data.user_id].close();
                delete peerConnections[data.user_id];
            }
        });

        socket.on('offer', async (data) => {
            console.log('Received offer from:', data.sender);
            try {
                let pc = peerConnections[data.sender];
                if (!pc) {
                    pc = createPeerConnection(data.sender);
                }
                
                console.log('Setting remote description for offer');
                await pc.setRemoteDescription(new RTCSessionDescription(data.offer));
                
                console.log('Creating answer');
                const answer = await pc.createAnswer({
                    offerToReceiveAudio: true,
                    offerToReceiveVideo: true
                });
                
                await pc.setLocalDescription(answer);
                console.log('Sending answer to:', data.sender);
                
                socket.emit('answer', {
                    target: data.sender,
                    answer: answer
                });
            } catch (error) {
                console.error('Error handling offer:', error);
            }
        });

        socket.on('answer', async (data) => {
            console.log('Received answer from:', data.sender);
            const pc = peerConnections[data.sender];
            if (pc) {
                try {
                    console.log('Setting remote description for answer');
                    await pc.setRemoteDescription(new RTCSessionDescription(data.answer));
                    console.log('Answer processed successfully');
                } catch (error) {
                    console.error('Error handling answer:', error);
                }
            } else {
                console.error('No peer connection found for:', data.sender);
            }
        });

        socket.on('ice_candidate', async (data) => {
            console.log('Received ICE candidate from:', data.sender);
            const pc = peerConnections[data.sender];
            if (pc && data.candidate) {
                try {
                    console.log('Adding ICE candidate');
                    await pc.addIceCandidate(new RTCIceCandidate(data.candidate));
                    console.log('ICE candidate added successfully');
                } catch (error) {
                    console.error('Error handling ICE candidate:', error);
                }
            } else {
                if (!pc) console.error('No peer connection found for ICE candidate from:', data.sender);
                if (!data.candidate) console.log('Received null ICE candidate (end of candidates)');
            }
        });

        // Control functions
        function toggleVideo() {
            isVideoEnabled = !isVideoEnabled;
            const videoBtn = document.getElementById('videoBtn');
            
            localStream.getVideoTracks().forEach(track => {
                track.enabled = isVideoEnabled;
            });
            
            if (isVideoEnabled) {
                videoBtn.classList.remove('off');
                videoBtn.innerHTML = 'üìπ';
            } else {
                videoBtn.classList.add('off');
                videoBtn.innerHTML = 'üìπ';
            }
        }

        function toggleAudio() {
            isAudioEnabled = !isAudioEnabled;
            const audioBtn = document.getElementById('audioBtn');
            
            localStream.getAudioTracks().forEach(track => {
                track.enabled = isAudioEnabled;
            });
            
            if (isAudioEnabled) {
                audioBtn.classList.remove('off');
                audioBtn.innerHTML = 'üé§';
            } else {
                audioBtn.classList.add('off');
                audioBtn.innerHTML = 'üîá';
            }
        }

        async function toggleScreen() {
            if (!isScreenSharing) {
                try {
                    const screenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true
                    });
                    
                    // Replace video track in all peer connections
                    const videoTrack = screenStream.getVideoTracks()[0];
                    
                    Object.values(peerConnections).forEach(pc => {
                        const sender = pc.getSenders().find(s => 
                            s.track && s.track.kind === 'video'
                        );
                        if (sender) {
                            sender.replaceTrack(videoTrack);
                        }
                    });
                    
                    // Update local video
                    const localVideo = document.querySelector('#localVideo video');
                    if (localVideo) {
                        localVideo.srcObject = screenStream;
                    }
                    
                    isScreenSharing = true;
                    document.getElementById('screenBtn').style.background = '#4CAF50';
                    showNotification('Screen sharing started');
                    
                    // Stop screen sharing when user stops sharing
                    videoTrack.onended = () => {
                        stopScreenSharing();
                    };
                    
                } catch (error) {
                    console.error('Error sharing screen:', error);
                    showNotification('Failed to share screen', 'error');
                }
            } else {
                stopScreenSharing();
            }
        }

        async function stopScreenSharing() {
            try {
                // Get camera stream again
                const cameraStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                
                const videoTrack = cameraStream.getVideoTracks()[0];
                
                // Replace screen track with camera track in all peer connections
                Object.values(peerConnections).forEach(pc => {
                    const sender = pc.getSenders().find(s => 
                        s.track && s.track.kind === 'video'
                    );
                    if (sender) {
                        sender.replaceTrack(videoTrack);
                    }
                });
                
                // Update local video
                const localVideo = document.querySelector('#localVideo video');
                if (localVideo) {
                    localVideo.srcObject = cameraStream;
                }
                
                localStream = cameraStream;
                isScreenSharing = false;
                document.getElementById('screenBtn').style.background = '#FF9800';
                showNotification('Screen sharing stopped');
                
            } catch (error) {
                console.error('Error stopping screen share:', error);
            }
        }

        function hangUp() {
            // Close all peer connections
            Object.values(peerConnections).forEach(pc => pc.close());
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Leave room
            socket.emit('leave_room', { room_id: roomId });
            
            // Redirect to home
            window.location.href = '/';
        }

        function copyRoomLink() {
            const roomLink = document.getElementById('roomLink');
            roomLink.select();
            roomLink.setSelectionRange(0, 99999);
            document.execCommand('copy');
            showNotification('Room link copied to clipboard!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            socket.emit('leave_room', { room_id: roomId });
        });

        // Initialize the app when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
